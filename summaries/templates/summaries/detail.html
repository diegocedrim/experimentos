{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="page-header">
    <h1>Sumário
        <small>{{ summary.element_fqn }}</small>
        <div class="btn-group pull-right" role="group">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                    Ordenar Seções
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a href="#" onclick="sort(alphabetical);">Alfabeticamente</a></li>
                    <li><a href="#" onclick="sort(granularity_asc);">Granularidade (crescente)</a></li>
                    <li><a href="#" onclick="sort(granularity_desc);">Granularidade (decrescente)</a></li>
                </ul>
            </div>
        </div>
    </h1>
</div>

<form class="form-horizontal" method="post" action="{% url 'summaries:save' summary.id %}">
    {% csrf_token %}
    <div id="basic_information_container">
        <div class="panel panel-default" id="agglomerations">
            <div class="panel-heading">
                <a data-toggle="collapse" href="#agg_collapse">
                    <strong>Aglomerações</strong>
                </a>
            </div>
            <div class="panel-body collapse" id="agg_collapse" style="height: 600px; padding: 0px;">
                <div id="agg_network"></div>
            </div>
        </div>

        <div class="panel panel-default" id="code_smells">
            <div class="panel-heading">
                <a data-toggle="collapse" href="#anomalies_collapse">
                    <strong>Anomalias de Código (Code Smells)</strong>
                </a>
            </div>
            <div class="panel-body collapse" id="anomalies_collapse" >
                {% for instance in smells_instances %}
                <dl class="dl-horizontal">
                    <dt>Anomalia</dt>
                    <dd>{{instance.smell.name}}</dd>
                    <dt>Descrição</dt>
                    <dd>{{instance.smell.description}}</dd>
                    <dt>Aglomerado?</dt>
                    <dd>{% if instance.is_part_of_agglomeration %} Sim {% else %} Não {% endif %}</dd>
                    <dt>Elemento</dt>
                    <dd>{{instance.affected_element}}</dd>
                    <dt>Razão</dt>
                    <dd>{{instance.reason}}</dd>
                    <dt>É Smell?</dt>
                    <dd><input type="checkbox" name="is_smell_{{instance.id}}" {% if instance.is_smell_by_user %} checked {% endif %}/></dd>
                </dl>
                {% if not forloop.last %}
                <hr/>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="panel panel-default" id="non_functional">
            <div class="panel-heading">
                <a data-toggle="collapse" href="#nonfunc_collapse">
                    <strong>Atributos Não Funcionais</strong>
                </a>
            </div>
            <div class="panel-body collapse" id="nonfunc_collapse">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>Atributo</th>
                        <th>Descrição</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for instance in summary.nonfunctionalattributeinstance_set.all %}
                    <tr>
                        <td>{{ instance.non_functional_attribute.name }}</td>
                        <td>{{ instance.non_functional_attribute.description }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel panel-default" id="design_patterns">
            <div class="panel-heading">
                <a data-toggle="collapse" href="#dpatterns_collapse">
                    <strong>Padrões de Projeto</strong>
                </a>
            </div>
            <div class="panel-body collapse" id="dpatterns_collapse">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th width="15%">Padrão</th>
                        <th width="40%">Descrição</th>
                        <th>Elementos Envolvidos</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for instance in summary.designpatterninstance_set.all %}
                    <tr>
                        <td>{{ instance.design_pattern.name }}</td>
                        <td>{{ instance.design_pattern.description }}</td>
                        <td>
                            <ul>
                                {% for el in instance.elements_list %}
                                <li>{{el}}</li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel panel-default" id="design_principles">
            <div class="panel-heading">
                <a data-toggle="collapse" href="#design_collapse">
                    <strong>Princípios de Design Violados</strong>
                </a>
            </div>
            <div class="panel-body collapse" id="design_collapse">
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th>Princípio</th>
                        <th>Descrição</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for instance in summary.designprincipleinstance_set.all %}
                    <tr>
                        <td>{{ instance.design_principle.name }}</td>
                        <td>{{ instance.design_principle.description }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="panel panel-default" id="examples">
            <div class="panel-heading">
                <strong>Sumários com Características Similares</strong>
            </div>
            <div class="panel-body">
                <ul>
                    {% for similar in summary.similar_summaries.all %}
                    <li>
                        <a href="{% url 'summaries:details' similar.id %}">{{ similar.element_fqn }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    <div class="panel panel-default">
        <div class="panel-heading"><strong>Informações Adicionais</strong></div>
        <div class="panel-body">
            <div class="form-group">
                <label for="rel_aglomeracao" class="col-sm-2 control-label">Aglomerações</label>
                <div class="col-sm-10">
                    <select id="rel_aglomeracao" name="rel_aglomeracao" class="form-control" required>
                        <option disabled selected value> -- selecione uma opção -- </option>
                        {% for imp in importance %}
                        <option value="{{imp.0}}" {% if answer.agglomeration_rating == imp.0 %} selected {% endif %}>{{imp.1}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="rel_dpatterns" class="col-sm-2 control-label">Padrões de Projeto</label>
                <div class="col-sm-10">
                    <select id="rel_dpatterns" name="rel_dpatterns" class="form-control" required>
                        <option disabled selected value> -- selecione uma opção -- </option>
                        {% for imp in importance %}
                        <option value="{{imp.0}}" {% if answer.design_patterns_rating == imp.0 %} selected {% endif %}>{{imp.1}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="rel_smells" class="col-sm-2 control-label">Anomalias de Código</label>
                <div class="col-sm-10">
                    <select id="rel_smells" name="rel_smells" class="form-control" required>
                        <option disabled selected value> -- selecione uma opção -- </option>
                        {% for imp in importance %}
                        <option value="{{imp.0}}" {% if answer.smells_rating == imp.0 %} selected {% endif %}>{{imp.1}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="rel_dprinciples" class="col-sm-2 control-label">Princípios de Design</label>
                <div class="col-sm-10">
                    <select id="rel_dprinciples" name="rel_dprinciples" class="form-control" required>
                        <option disabled selected value> -- selecione uma opção -- </option>
                        {% for imp in importance %}
                        <option value="{{imp.0}}" {% if answer.design_principles_rating == imp.0 %} selected {% endif %}>{{imp.1}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="rel_examples" class="col-sm-2 control-label">Exemplos</label>
                <div class="col-sm-10">
                    <select id="rel_examples" name="rel_examples" class="form-control" required>
                        <option disabled selected value> -- selecione uma opção -- </option>
                        {% for imp in importance %}
                        <option value="{{imp.0}}" {% if answer.examples_rating == imp.0 %} selected {% endif %}>{{imp.1}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="observations" class="col-sm-2 control-label">Problema Identificado</label>
                <div class="col-sm-10">
                    <textarea id="observations" name="observations" class="form-control" rows="3" required>{{ answer.observations }}</textarea>
                </div>
            </div>
        </div>
    </div>

    <button type="submit" class="btn pull-right btn btn-success btn-lg">Salvar</button>

</form>

<script type="text/javascript">
  // create an array with nodes
  var nodes = new vis.DataSet([
    {% for node in summary.nodes %}
       {% if node == summary.element_fqn %}
            {id: '{{node}}', label: '{{node}}', title:'{{ summary.smells|get_item:node }}', color:'#FF6666'},
       {% else %}
            {id: '{{node}}', label: '{{node}}', title:'{{ summary.smells|get_item:node }}', color:'#97C2FC'},
       {% endif %}
    {% endfor %}
  ]);

  // create an array with edges
  var edges = new vis.DataSet([
    {% for edge in summary.edges %}
        {% if edge.2 == 'R' %}
            {from: '{{edge.0}}', to: '{{edge.1}}', arrows:'to', dashes:true, color:'#97C2FC'},
        {% endif %}
        {% if edge.2 == 'I' %}
            {from: '{{edge.0}}', to: '{{edge.1}}', arrows:'to', color:'#97C2FC'},
        {% endif %}
        {% if edge.2 == 'A' %}
            {from: '{{edge.0}}', to: '{{edge.1}}', color:'#97C2FC'},
        {% endif %}
    {% endfor %}
  ]);

  // create a network
  var container = document.getElementById('agg_network');
  var data = {
    nodes: nodes,
    edges: edges
  };
  var options = {
    nodes: {
        shape: 'box',
        borderWidth: 1,
        shadow:true,
        "physics": false
    },
    edges: {
        width: 1,
        shadow:true,
        "smooth": {
          "forceDirection": "none"
        }
    },
    "physics": {
       "minVelocity": 0.75,
        "solver": "repulsion"
    }
  };
  var network = new vis.Network(container, data, options);

  $('#agg_collapse').on('shown.bs.collapse', function () {
    network.fit();
  })
</script>

<script src="{% static 'summaries/js/summary_details.js' %}"></script>


{% endblock %}

